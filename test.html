<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì›¹ ê²€ìƒ‰ ê¸°ë°˜ AI ì—ì´ì „íŠ¸</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px 40px;
      line-height: 1.6;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1fr);
      gap: 24px;
      align-items: flex-start;
    }

    .card {
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
      background: #ffffff;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      resize: vertical;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .label {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 4px;
      display: block;
    }
    .output {
      margin-top: 12px;
      font-size: 0.95rem;
      white-space: pre-wrap;
    }
    .meta {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .error {
      margin-top: 10px;
      color: #b91c1c;
      font-size: 0.9rem;
    }
    .chat-window {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      max-height: 520px;
      overflow-y: auto;
      padding: 10px 12px;
    }
    .chat-message {
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
    }
    .chat-message.user {
      justify-content: flex-end;
    }
    .chat-bubble {
      max-width: 80%;
      padding: 8px 11px;
      border-radius: 14px;
      font-size: 0.93rem;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
    }
    .chat-message.user .chat-bubble {
      background: #2563eb;
      border-color: #2563eb;
      color: #ffffff;
    }
    .chat-meta {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    .label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .icon-btn {
      margin-top: 0;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      background: #111827;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.8rem;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <h1>ì›¹ ê²€ìƒ‰ ê¸°ë°˜ AI ì—ì´ì „íŠ¸</h1>
  <p style="color:#4b5563; font-size:0.95rem;">
    ë°±ì—”ë“œ FastAPI ì„œë²„(<code>http://localhost:8000</code>)ê°€ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
  </p>

  <div class="layout">
    <!-- ì™¼ìª½: ëŒ€í™” ì˜ì—­ -->
    <div class="card">
      <div class="label-row">
        <label class="label" for="question">ëŒ€í™” / íŒŒì¼ ì—…ë¡œë“œ</label>
        <button id="fileTriggerBtn" type="button" class="icon-btn">+ íŒŒì¼</button>
      </div>

      <!-- ì‹¤ì œ íŒŒì¼ ì…ë ¥ì€ ìˆ¨ê¸°ê³ , +ë²„íŠ¼ìœ¼ë¡œë§Œ ì—´ê¸° -->
      <input type="file" id="fileInput" accept=".pdf,.txt" style="display:none;" />
      <div id="fileInfo" class="meta" style="display:none;">
        <span class="pill" id="fileNamePill"></span>
      </div>

      <div class="chat-window" id="chatWindow">
        <!-- ëŒ€í™” ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— append ë¨ -->
      </div>

      <div style="margin-top:10px;">
        <textarea id="question" placeholder="ì˜ˆ: ì´ ì œí’ˆì´ ì–´ë–¤ ì˜ë£Œê¸°ê¸°ì¸ì§€ ì•Œë ¤ì¤˜ / ì´ ë¬¸ì„œë¥¼ ë²ˆì—­í•´ì¤˜ / ì´ ê³„ì•½ì„œì—ì„œ ìœ„í—˜í•œ ì¡°í•­ë§Œ ë½‘ì•„ì¤˜"></textarea>
        <button id="sendBtn">ì—ì´ì „íŠ¸ì—ê²Œ ì§ˆë¬¸í•˜ê¸°</button>
      </div>

      <div id="error" class="error" style="display:none;"></div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ìš”ì•½/ê°€ì´ë“œ ì¹´ë“œ -->
    <div class="card">
      <div style="font-size:0.9rem; color:#f97316; margin-bottom:6px;">ğŸ”¥ ì´ ì—ì´ì „íŠ¸ ì‚¬ìš© ìš”ì•½</div>
      <ul style="padding-left:18px; font-size:0.9rem; color:#374151; margin-top:4px;">
        <li>ì¼ë°˜ ì§ˆë¬¸ì€ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.</li>
        <li>ë¸Œë¡œì…”Â·ê³„ì•½ì„œÂ·ë§¤ë‰´ì–¼ì€ <strong>+ íŒŒì¼</strong> ë²„íŠ¼ìœ¼ë¡œ ì—…ë¡œë“œ í›„ ì§ˆë¬¸ì„ ì ì–´ì£¼ì„¸ìš”.</li>
        <li>â€œë²ˆì—­í•´ì¤˜â€ë¼ê³ ë§Œ í•´ë„ ë¬¸ì„œ ì„±ê²©ì„ ë³´ê³  ë¸Œë¡œì…” í†¤ìœ¼ë¡œ ë²ˆì—­í•©ë‹ˆë‹¤.</li>
        <li>ìœ„í—˜ ì¡°í•­, í•µì‹¬ í¬ì¸íŠ¸ë§Œ ë½‘ê¸° ë“± ë¬¸ì„œ ê¸°ë°˜ ë¶„ì„ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      </ul>
      <hr style="margin:12px 0; border:none; border-top:1px solid #e5e7eb;" />
      <div style="font-size:0.85rem; color:#6b7280;">
        ì´ í˜ì´ì§€ëŠ” í…ŒìŠ¤íŠ¸ìš© í”„ë¡ íŠ¸ì…ë‹ˆë‹¤. ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì´ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ê°€
        ì‚¬ë‚´ í¬í„¸ì´ë‚˜ ê³ ê°ìš© ì›¹ì‚¬ì´íŠ¸ì— ë¶™ì´ë©´ ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <script>
    // ê³µí†µ ìš”ì†Œ
    const btn = document.getElementById('sendBtn');
    const questionEl = document.getElementById('question');
    const errorEl = document.getElementById('error');
    const chatWindowEl = document.getElementById('chatWindow');

    // ëŒ€í™” ë‚´ì—­ (í”„ë¡ íŠ¸ì—ì„œë§Œ ê´€ë¦¬, ë°±ì—”ë“œ APIëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
    const conversation = [];

    // íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨
    const fileTriggerBtn = document.getElementById('fileTriggerBtn');
    const fileInput = document.getElementById('fileInput');
    const fileInfoEl = document.getElementById('fileInfo');
    const fileNamePillEl = document.getElementById('fileNamePill');

    fileTriggerBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) {
        fileNamePillEl.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
        fileInfoEl.style.display = 'block';
      } else {
        fileInfoEl.style.display = 'none';
        fileNamePillEl.textContent = '';
      }
    });

    function appendMessage(role, text, meta) {
      const wrap = document.createElement('div');
      wrap.className = `chat-message ${role}`;

      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble';
      bubble.textContent = text;

      wrap.appendChild(bubble);

      if (meta) {
        const metaEl = document.createElement('div');
        metaEl.className = 'chat-meta';
        metaEl.textContent = meta;
        wrap.appendChild(metaEl);
      }

      chatWindowEl.appendChild(wrap);
      chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
    }

    function buildHistoryForPrompt() {
      if (!conversation.length) return '';
      return conversation
        .map(m => `${m.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${m.text}`)
        .join('\n');
    }

    // Enter í‚¤: Shift+EnterëŠ” ì¤„ë°”ê¿ˆ, Enter ë‹¨ë…ì€ ì „ì†¡
    // - textareaì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•Œë§Œ ë™ì‘í•˜ë„ë¡ document ë ˆë²¨ì—ì„œ í•œ ë²ˆ ë” ì²´í¬
    document.addEventListener('keydown', (event) => {
      const isQuestionFocused = document.activeElement === questionEl;
      if (!isQuestionFocused) return;
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        btn.click();
      }
    });

    // ì „ì†¡ ë²„íŠ¼: íŒŒì¼ì´ ìˆìœ¼ë©´ /agent/file, ì—†ìœ¼ë©´ /agent í˜¸ì¶œ
    btn.addEventListener('click', async () => {
      const q = questionEl.value.trim();
      const file = fileInput.files[0] || null;

      if (!q && !file) {
        errorEl.style.display = 'block';
        errorEl.textContent = 'ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.';
        return;
      }

      errorEl.style.display = 'none';

      btn.disabled = true;
      btn.textContent = 'ìš”ì²­ ì¤‘...';

      try {
        let data;
        let userVisibleQuestion = q || (file ? 'ì´ íŒŒì¼ì„ ìš”ì•½í•´ì¤˜' : '');

        // í”„ë¡ íŠ¸ì—ì„œ ëŒ€í™” ë‚´ì—­ì„ ìœ ì§€í•˜ê³ , íˆìŠ¤í† ë¦¬ë¥¼ í•¨ê»˜ ë³´ë‚¸ë‹¤.
        const history = buildHistoryForPrompt();

        if (file) {
          // íŒŒì¼ ê¸°ë°˜ ìš”ì²­: ì§ˆë¬¸ì´ ë¹„ì–´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
          const questionForFile = userVisibleQuestion || 'ì´ íŒŒì¼ì„ ìš”ì•½í•´ì¤˜';
          const formData = new FormData();
          formData.append('file', file);

          const combinedQuestionForFile = history
            ? `${history}\n\nìƒˆ ì§ˆë¬¸: ${questionForFile}`
            : questionForFile;

          formData.append('question', combinedQuestionForFile);

          const res = await fetch('http://localhost:8000/agent/file', {
            method: 'POST',
            body: formData,
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.detail || `HTTP ${res.status}`);
          }

          data = await res.json();
        } else {
          // ì¼ë°˜ ì§ˆë¬¸ ìš”ì²­
          const questionForAgent = history
            ? `${history}\n\nìƒˆ ì§ˆë¬¸: ${q}`
            : q;

          const res = await fetch('http://localhost:8000/agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: questionForAgent }),
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.detail || `HTTP ${res.status}`);
          }

          data = await res.json();
        }

        // ëŒ€í™” ë‚´ì—­ ë° UI ì—…ë°ì´íŠ¸
        if (userVisibleQuestion) {
          conversation.push({ role: 'user', text: userVisibleQuestion });
          appendMessage('user', userVisibleQuestion, file ? (data.filename ? `íŒŒì¼: ${data.filename}` : '') : '');
        }

        const answerText = data.answer || '(ë¹ˆ ì‘ë‹µ)';
        const usedSearchText = data.used_search
          ? 'ê²€ìƒ‰ì„ í™œìš©í•œ ë‹µë³€ìœ¼ë¡œ ì¶”ì •ë©ë‹ˆë‹¤.'
          : 'ê²€ìƒ‰ ì‚¬ìš© í”ì ì´ ì—†ëŠ” ë‹µë³€ì…ë‹ˆë‹¤.';

        conversation.push({ role: 'assistant', text: answerText });
        appendMessage('assistant', answerText, usedSearchText);

        // ì…ë ¥ì°½ ì´ˆê¸°í™” (íŒŒì¼ì€ ìœ ì§€)
        questionEl.value = '';
      } catch (err) {
        errorEl.style.display = 'block';
        errorEl.textContent = `ì˜¤ë¥˜: ${err.message}`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'ì—ì´ì „íŠ¸ì—ê²Œ ì§ˆë¬¸í•˜ê¸°';
      }
    });
  </script>
</body>
</html>


